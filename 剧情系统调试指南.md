# 剧情系统调试指南

## 问题分析
之前按下1没有反应的原因可能有以下几点：
1. `Player`类缺少`GetLevel()`方法，导致`checkMapTrigger`函数调用失败
2. 地图触发条件检查的代码被注释掉了
3. 剧情系统初始化或触发存在问题

## 已做的修改
1. 在`StorySystem.h`中添加了`Player`类的提前声明
2. 在`MainShell.h`中取消了地图触发条件检查的注释
3. 在`MainShell.h`中添加了调试信息输出和手动触发剧情功能
4. 在`Player`类中添加了`GetLevel()`方法

## 测试方法

### 1. 手动触发剧情
- 运行游戏后，按`P`键手动触发初始剧情
- 如果剧情界面出现，说明剧情系统基本工作正常
- 使用数字键`1`、`2`、`3`选择选项，观察是否能正常切换剧情节点

### 2. 检查玩家位置和等级
- 游戏运行时，屏幕上会每100帧显示一次玩家位置和等级
- 确认玩家位置坐标和等级是否正确显示

### 3. 测试地图触发条件
- 根据`StorySystem.h`中的设置，当玩家到达坐标`(10, 10)`且等级大于5时，会自动触发剧情节点1
- 可以通过修改`player.json`文件来调整玩家的位置和等级
- 或者修改`StorySystem.h`中的触发条件，设置更容易满足的条件进行测试

## 进一步调试建议
1. 如果剧情仍然无法触发，可以在`DrawPlots()`函数中添加更多的调试输出
2. 检查`g_storySystem.isActive()`的返回值是否正确
3. 确认`player`对象是否正确初始化
4. 检查`MainGame()`函数是否在主循环中被正确调用
5. 如果使用C++调试器，可以设置断点跟踪剧情系统的执行流程

## 修改后的关键代码

### 1. `MainShell.h`中的`DrawPlots()`函数
```cpp
void DrawPlots() {
    // 检查剧情是否活跃
    if (g_storySystem.isActive()) {
        // 绘制剧情文本和选项...
        // 处理选项输入
        if (_kbhit()) {
            int ch = _getch() - '0';
            if (ch >= 1 && ch <= static_cast<int>(choices.size())) {
                g_storySystem.chooseOption(ch - 1);
                // 如果是结束节点，结束剧情
                if (currentNode.isEnd()) {
                    g_storySystem.endStory();
                }
            }
        }
    } else {
        // 显示调试信息...
        // 检查是否按下P键手动触发剧情
        if (_kbhit()) {
            int ch = _getch();
            if (ch == 'p' || ch == 'P') {
                g_storySystem.startStory(0);
            }
        }
        // 检查地图触发条件
        if (g_storySystem.checkMapTrigger(player.GetX(), player.GetY(), player)) {
            // 剧情已触发
        }
    }
}
```

### 2. `Player`类中的`GetLevel()`方法
```cpp
class Player : public Person {
    // ...其他成员变量和方法...
public:
    // ...其他方法...
    int GetLevel() const { return Level; }
    // ...其他方法...
};
```